---
title: "mapmetadata tutorial"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mapmetadata tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

For installation, set-up and basic usage refer to the package [README.md](https://aim-rsf.github.io/mapmetadata/index.html) file. In this tutorial, you will find more context on package inputs, how to interact with package functions and interpret package outputs.

# Preparing for mapping

<img src="https://raw.githubusercontent.com/aim-rsf/mapmetadata/main/inst/outputs/BAR_360_NCCHD_2024-12-19-14-11-55.png" alt="example bar plot showing number of variables for each table alongside counts of whether variables have missing descriptions"/>

This bar plot is produced automatically when you run the `[metadata_map](https://github.com/aim-rsf/mapmetadata/tree/main/R/metadata_map.R)` function with the demo metadata file, which contains metadata about the **National Community Child Health Database (NCCHD).**

The bar plot shows us there are 13 tables in the dataset. The height of the bar indicates the number of variables in that table:

-   The ones with lots of variables (e.g. CHILD_TRUST) will take you longer to process (caveat: see HDRUK Gateway screenshot below)
-   Some tables (e.g. CHE_HEALTHYCHILDWALESPROGRAMME) have a lot of empty descriptions. An empty description means that this variable will only have a label and a data type.

It is important to note that this plot is only summarising *variable* level metadata i.e. a description of what the variable is. Some variables also require *value* level metadata i.e. what does each value correspond to, 1 = Yes, 2 = No, 3 = Unknown. This *value* level metadata can sometimes be found in lookup tables, if it is not provided within the *variable* level description.

The bar plot can help you understand the scope of the dataset, but reference the HDRUK Gateway page for the fuller context. For instance, table descriptions are not included in these structural metadata files but they are included on the gateway:

For dataset NCCHD, used in the demo, the structural metadata was downloaded from <https://healthdatagateway.org/en/dataset/360>. Below, we include a screenshot of this page; a user must click on the 'Download Data' then 'Structural Metadata' in order to download the file. Please note, we are working on API integration with this package to streamline this for users.

<img src="https://raw.githubusercontent.com/aim-rsf/mapmetadata/main/inst/outputs/NCCHD_gateway_download.png" alt="screenshot of HRDRUK gateway showing location to download structural metadata"/>

It is recommended to view the descriptions of each table to give you more context on their contents and how to use them:

<img src="https://raw.githubusercontent.com/aim-rsf/mapmetadata/main/inst/outputs/NCCHD_gateway_table.png" alt="screenshot of HRDRUK gateway showing table descriptions for the NCCHD dataset"/>

# Understanding mapping outputs

Running `[metadata_map](https://github.com/aim-rsf/mapmetadata/tree/main/R/metadata_map.R)` will run this function in demo mode (as explained in the README) and generate four files in your project directory. 

By default, the demo mode processes the first 5 variables in a table. Running `metadata_map(demo_number = 20)` will process the first 20 variables in a table. 
Here you can [view outputs generated from this longer demo run](https://github.com/aim-rsf/mapmetadata/tree/main/inst/outputs/), which include:

-   **BAR_360_NCCHD_timestamp.png**
    -   The bar plot that opened in your browser. It will save as a .html file but you can choose the 'Download plot as png' option.
-   **BAR_360_NCCHD_timestamp.csv**
    -   The data that created this bar plot.
-   **MAPPING_360_NCCHD_CHILD_timestamp.csv**
    -   The mappings between variables in the CHILD table and the research domains.
-   **L-MAPPING_360_NCCHD_CHILD_timestamp.csv**
    -   The same mappings as the previous file, but saved in a longer format. See the argument `long_output = TRUE` in `[metadata_map](https://github.com/aim-rsf/mapmetadata/tree/main/R/metadata_map.R)`. If `long_output = FALSE` was used, the long outputs can be generated by directly calling the `[map_convert](https://github.com/aim-rsf/mapmetadata/tree/main/R/map_convert.R)` function. 
-   **MAPPING_LOG_360_NCCHD_CHILD_timestamp.csv**
    -   A log file that accompanies the MAPPING file, describing features of the session and the table processed.
-   **MAPPING_PLOT_360_NCCHD_CHILD_timestamp.png**
    -   A simple visual representation of the mappings, displaying the count of each domain code.

# Compare mapping

Running the function `[map_compare](https://github.com/aim-rsf/mapmetadata/tree/main/R/map_compare.R)` will allow you to compare the mappings from two sessions, perhaps two different researchers. This function compares csv outputs from two sessions, finds their differences, and asks for a consensus, creating a new output file:

**CONSENSUS_MAPPING_360_NCCHD_CHILD_timestamp.csv**

# Using a custom metadata input (recommended) 

Currently, the way to retrieve a metadata file that is compatible with this package is to:

1. Visit the [Health Data Research Gateway](https://healthdatagateway.org/en/search?type=datasets) website
2. Browse for the dataset you want, click on it to move to its main page
3. Click on 'Download data' button and select 'Structural Metadata'  
4. Rename this file to be 'ID_Name_Metadata.csv' with 'ID' and 'Name' being changed depending on the specific dataset download

The demo metadata file used in this package is [360_NCCHD_Metadata.csv](https://github.com/aim-rsf/mapmetadata/tree/main/inst/inputs/360_NCCHD_Metadata.csv), with 360 being the ID given by HDRUK Gateway and NCCHD being the abbreviation for the dataset name (National Community Child Health Database).

Any metadata file in the same format as this download should work with this package.

Run `data("metadata")` to load the demo metadata into your R environment. 
This demo metadata is also included as a package file and is retrieved using the `system.file()` function:

```r
ncchd_metadata_csv <- system.file("inputs/360_NCCHD_Metadata.csv", package = "mapmetadata")
demo_domains_csv <- system.file("inputs/domain_list_demo.csv", package = "mapmetadata")
metadata_map(metadata_file = ncchd_metadata_csv, domain_file = demo_domains_csv)
```

# Using a custom domain list input (recommended)

You can use a custom domain list input instead of using the default, e.g. `metadata_map(metadata_file = ID_Name_Metadata.csv, domain_file = my_domain_list.csv)`.

Run `data("domain_list")` to load the demo domain list into your R environment (you can also read the package file with `system.file("inputs/domain_list_demo.csv", package = "mapmetadata"`).

```r
data("domain_list")
print(domain_list)
1  NO MATCH / UNSURE
2           METADATA
3                 ID
4       DEMOGRAPHICS
5 Socioeconomic info
6      Location info
7     Education info
8        Health info
```
Change this csv domain file to be more specific to your research domains (sometimes called latent variables or concepts) as these are broad and generic categories for demo purposes. 

It is strongly recommended to keep the first four domains (NO MATCH / UNSURE, METADATA, ID, DEMOGRAPHICS). If you change them, you also have to change the lookup table.

# Using a custom lookup table input (advanced) 

Run `data("look_up")` to load the demo look up table into your R environment (you can also read the package file with `system.file("inputs/look_up.csv", package = "mapmetadata")`).

```r
data("look_up")
print(look_up)
                      variable      domain_label domain_code
1                         NA   No Match / Unsure           1
2                AVAIL_FROM_DT          Metadata           2
3                        ALF_E                ID           3
4                 MOTHER_ALF_E                ID           3
5                  CHILD_ALF_E                ID           3
6                         RALF                ID           3
7                   ALF_STS_CD                ID           3
8            MOTHER_ALF_STS_CD                ID           3
9             CHILD_ALF_STS_CD                ID           3
10                ALF_MTCH_PCT                ID           3
11         MOTHER_ALF_MTCH_PCT                ID           3
12          CHILD_ALF_MTCH_PCT                ID           3
13     SERVICE_USER_LOCAL_ID_E                ID           3
14 MAT_SERVICE_USER_LOCAL_ID_E                ID           3
15                 CLIENT_ID_E                ID           3
16                         AGE      Demographics           4
17                     MAT_AGE      Demographics           4
18              MAT_AGE_AT_ASS      Demographics           4
19                 CONTACT_AGE      Demographics           4
20                         WOB      Demographics           4
21                     MAT_WOB      Demographics           4
22                         SEX      Demographics           4
23         SERVICE_USER_SEX_CD      Demographics           4
24             NENONATE_SEX_CD      Demographics           4
25                      GENDER      Demographics           4
26                        GNDR      Demographics           4
27                     GNDR_CD      Demographics           4
```

The default lookup table (printed above) governs the automatic categorisations. If you modify the default lookup file you must ensure that all values contained in the domain_code column map to the the domain_file in the way you intend. 
For example, we can see that the domain_file has 8 domains, which will be labelled with 1-8 by the function. If we included a '0' or '9' in the domain_code column of the lookup file, they would have nothing to map to, and the function would crash.

# Copying across tables

If you're processing multiple tables (i.e. in run one of `[metadata_map](https://github.com/aim-rsf/mapmetadata/tree/main/R/metadata_map.R)` select table one, in run two select table two) save all outputs in the same directory to enable table copying. This feature will speed up categorisation and ensure consistency. 
If it finds other MAPPING files with the same ID_Name in the output directory, and they contain overlapping variables, it will automatically copy the mappings from this previous table to the current table.

```r
Selection: 4
ℹ Processing Table 4 of 13 (CHILD)

ℹ Copying from previous session(s): MAPPING_360_NCCHD_CHILD_2025-02-14-18-14-01.csv
```
Instead of 'AUTO CATEGORISED' the note will say 'COPED FROM: CHILD' but you always have the option to manually override this copying during your review, or turn it off altogether with the option `table_copy = FASLE`.
